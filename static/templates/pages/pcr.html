{{ define "page" }}
<style>
    .pcr-container { max-width: 900px; }
    .pcr-empty-icon { font-size: 3rem; }
</style>
<div class="d-flex w-100 h-100">
    <div class="pt-4 w-100 h-100 overflow-y-scroll">
        <div class="container pcr-container">
            <!-- Page Header with Context -->
            <header class="mb-4">
                <h1 class="h3 mb-2">Password Change Request (PCR)</h1>
                <p class="text-muted mb-0">Update service credentials for your team's scored systems.</p>
            </header>

            <!-- Global Alert Container - for status messages -->
            <div id="alert-container" role="status" aria-live="polite"></div>

            <!-- Selection Controls - Always Visible -->
            <section class="card mb-4" aria-labelledby="selection-heading">
                <div class="card-body">
                    <h2 class="visually-hidden" id="selection-heading">Select Team and Credential List</h2>
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label for="team-select" class="form-label fw-semibold">
                                <i class="bi bi-people me-1" aria-hidden="true"></i>Team
                            </label>
                            <select class="form-select" id="team-select" aria-describedby="team-help">
                                <option value="" disabled selected>Loading teams...</option>
                            </select>
                            <div id="team-help" class="form-text">{{ if .IsAdmin }}Select the team to modify credentials for.{{ else }}Your team.{{ end }}</div>
                        </div>
                        <div class="col-sm-6">
                            <label for="credlist-select" class="form-label fw-semibold">
                                <i class="bi bi-list-ul me-1" aria-hidden="true"></i>Credential List
                            </label>
                            <select class="form-select" id="credlist-select" aria-describedby="credlist-help">
                                <option value="" disabled selected>Loading credential lists...</option>
                            </select>
                            <div id="credlist-help" class="form-text">Choose which service credentials to update.</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Main Content Tabs - Progressive Disclosure -->
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="pcr-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="update-tab" data-bs-toggle="tab"
                                    data-bs-target="#update-panel" type="button" role="tab"
                                    aria-controls="update-panel" aria-selected="true">
                                Update
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="view-tab" data-bs-toggle="tab"
                                    data-bs-target="#view-panel" type="button" role="tab"
                                    aria-controls="view-panel" aria-selected="false">
                                Usernames
                            </button>
                        </li>
                        {{ if .IsAdmin }}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="history-tab" data-bs-toggle="tab"
                                    data-bs-target="#history-panel" type="button" role="tab"
                                    aria-controls="history-panel" aria-selected="false">
                                History
                            </button>
                        </li>
                        {{ end }}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="help-tab" data-bs-toggle="tab"
                                    data-bs-target="#help-panel" type="button" role="tab"
                                    aria-controls="help-panel" aria-selected="false">
                                Help
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="tab-content">
                    <!-- Update Credentials Tab -->
                    <div class="tab-pane fade show active" id="update-panel" role="tabpanel"
                         aria-labelledby="update-tab" tabindex="0">
                        <div class="card-body">
                            <form id="pcr-form" aria-describedby="form-instructions">
                                <div id="form-instructions" class="alert alert-info mb-3" role="note">
                                    <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
                                    Enter credentials in <code>username,password</code> format, one per line.
                                </div>

                                <div class="mb-3">
                                    <label for="pcr-credentials" class="form-label fw-semibold">
                                        Credentials
                                        <span class="text-muted fw-normal ms-1">(required)</span>
                                    </label>
                                    <textarea
                                        class="form-control font-monospace"
                                        id="pcr-credentials"
                                        rows="8"
                                        placeholder="administrator,NewP@ssw0rd&#10;john.doe,SecurePass123&#10;jane.smith,MyPassword!"
                                        aria-describedby="credentials-help"
                                        required
                                    ></textarea>
                                    <div id="credentials-help" class="form-text">
                                        <span id="line-count">0 credentials entered</span>
                                    </div>
                                </div>

                                <details class="mb-3">
                                    <summary class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-gear me-1" aria-hidden="true"></i>Advanced Options
                                    </summary>
                                    <div class="mt-2 p-3 bg-body-secondary rounded">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="strip-quotes" checked>
                                            <label class="form-check-label" for="strip-quotes">
                                                Strip surrounding quotes from values
                                            </label>
                                            <div class="form-text">
                                                Automatically removes <code>"quotes"</code> or <code>'quotes'</code> from usernames and passwords.
                                            </div>
                                        </div>
                                    </div>
                                </details>

                                <div class="d-flex flex-wrap gap-2">
                                    <button type="submit" class="btn btn-primary" id="submit-btn">
                                        <span class="btn-text">
                                            <i class="bi bi-check-lg me-1" aria-hidden="true"></i>Submit Changes
                                        </span>
                                        <span class="btn-loading d-none">
                                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                            Submitting...
                                        </span>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" id="reset-btn">
                                        <i class="bi bi-arrow-counterclockwise me-1" aria-hidden="true"></i>Reset to Defaults
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- View Usernames Tab (passwords shown only for admin) -->
                    <div class="tab-pane fade" id="view-panel" role="tabpanel"
                         aria-labelledby="view-tab" tabindex="0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <p class="mb-0 text-muted">
                                    {{ if .IsAdmin }}View current credentials for the selected team.{{ else }}Available usernames for this credential list.{{ end }}
                                </p>
                                <button class="btn btn-sm btn-outline-primary" id="refresh-credentials-btn">
                                    <i class="bi bi-arrow-clockwise me-1" aria-hidden="true"></i>Refresh
                                </button>
                            </div>

                            <!-- Loading State -->
                            <div id="credentials-loading" class="text-center py-4 d-none">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading...</p>
                            </div>

                            <!-- Empty State -->
                            <div id="credentials-empty" class="text-center py-4 d-none">
                                <i class="bi bi-inbox text-muted pcr-empty-icon" aria-hidden="true"></i>
                                <p class="mt-2 text-muted">No usernames found for this selection.</p>
                            </div>

                            <!-- Error State -->
                            <div id="credentials-error" class="alert alert-danger d-none" role="alert">
                                <i class="bi bi-exclamation-triangle me-1" aria-hidden="true"></i>
                                <span id="credentials-error-msg">Failed to load data.</span>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="loadCredentials()">
                                    Retry
                                </button>
                            </div>

                            <!-- Data Table -->
                            <div id="credentials-table-container" class="d-none">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" aria-describedby="credentials-caption">
                                        <caption id="credentials-caption" class="visually-hidden">
                                            {{ if .IsAdmin }}Current credentials{{ else }}Available usernames{{ end }}
                                        </caption>
                                        <thead class="table-light">
                                            <tr>
                                                <th scope="col">Username</th>
                                                {{ if .IsAdmin }}<th scope="col">Password</th>{{ end }}
                                            </tr>
                                        </thead>
                                        <tbody id="credentials-table-body">
                                        </tbody>
                                    </table>
                                </div>
                                <p class="text-muted small mt-2">
                                    <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
                                    <span id="credentials-count">0</span> {{ if .IsAdmin }}credentials{{ else }}usernames{{ end }} shown
                                </p>
                            </div>
                        </div>
                    </div>

                    {{ if .IsAdmin }}
                    <!-- History Tab (Admin) -->
                    <div class="tab-pane fade" id="history-panel" role="tabpanel"
                         aria-labelledby="history-tab" tabindex="0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <p class="mb-0 text-muted">
                                    Audit log of all credential changes.
                                </p>
                                <button class="btn btn-sm btn-outline-primary" id="refresh-history-btn">
                                    <i class="bi bi-arrow-clockwise me-1" aria-hidden="true"></i>Refresh
                                </button>
                            </div>

                            <!-- Loading State -->
                            <div id="history-loading" class="text-center py-4 d-none">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading history...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading change history...</p>
                            </div>

                            <!-- Empty State -->
                            <div id="history-empty" class="text-center py-4 d-none">
                                <i class="bi bi-clock text-muted pcr-empty-icon" aria-hidden="true"></i>
                                <p class="mt-2 text-muted">No changes recorded for this selection.</p>
                            </div>

                            <!-- Error State -->
                            <div id="history-error" class="alert alert-danger d-none" role="alert">
                                <i class="bi bi-exclamation-triangle me-1" aria-hidden="true"></i>
                                <span id="history-error-msg">Failed to load history.</span>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="loadHistory()">
                                    Retry
                                </button>
                            </div>

                            <!-- Data Table -->
                            <div id="history-table-container" class="d-none">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover table-sm" aria-describedby="history-caption">
                                        <caption id="history-caption" class="visually-hidden">
                                            History of credential changes
                                        </caption>
                                        <thead class="table-light">
                                            <tr>
                                                <th scope="col">Username</th>
                                                <th scope="col">Old Password</th>
                                                <th scope="col">New Password</th>
                                                <th scope="col">Changed By</th>
                                                <th scope="col">Time</th>
                                            </tr>
                                        </thead>
                                        <tbody id="history-table-body">
                                        </tbody>
                                    </table>
                                </div>
                                <p class="text-muted small mt-2">
                                    <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
                                    <span id="history-count">0</span> changes shown (most recent first)
                                </p>
                            </div>
                        </div>
                    </div>
                    {{ end }}

                    <!-- Help Tab -->
                    <div class="tab-pane fade" id="help-panel" role="tabpanel"
                         aria-labelledby="help-tab" tabindex="0">
                        <div class="card-body">
                            <h3 class="h5 mb-3">How to Use PCR</h3>

                            <div class="accordion" id="help-accordion">
                                <div class="accordion-item">
                                    <h4 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                                data-bs-target="#help-basics" aria-expanded="true">
                                            Getting Started
                                        </button>
                                    </h4>
                                    <div id="help-basics" class="accordion-collapse collapse show" data-bs-parent="#help-accordion">
                                        <div class="accordion-body">
                                            <ol>
                                                <li><strong>Verify your team</strong> is selected at the top.</li>
                                                <li><strong>Choose a credential list</strong> (e.g., SSH users, web admin).</li>
                                                <li><strong>Enter credentials</strong> in <code>username,password</code> format.</li>
                                                <li><strong>Click Submit</strong> to save your changes.</li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>

                                <div class="accordion-item">
                                    <h4 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                                data-bs-target="#help-format" aria-expanded="false">
                                            Input Format
                                        </button>
                                    </h4>
                                    <div id="help-format" class="accordion-collapse collapse" data-bs-parent="#help-accordion">
                                        <div class="accordion-body">
                                            <p>Enter one credential per line in this format:</p>
                                            <pre class="bg-body-secondary p-2 rounded"><code>username,password</code></pre>
                                            <p class="mb-1"><strong>Examples:</strong></p>
                                            <pre class="bg-body-secondary p-2 rounded"><code>administrator,MyNewP@ss123
john.doe,SecurePassword!
"quoted_user","quoted,password"</code></pre>
                                            <p class="text-muted small mb-0">
                                                Tip: Enable "Strip quotes" to automatically remove surrounding quotes.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div class="accordion-item">
                                    <h4 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                                data-bs-target="#help-reset" aria-expanded="false">
                                            Resetting Credentials
                                        </button>
                                    </h4>
                                    <div id="help-reset" class="accordion-collapse collapse" data-bs-parent="#help-accordion">
                                        <div class="accordion-body">
                                            <p>The <strong>Reset to Defaults</strong> button restores all credentials
                                            in the selected list to their original values.</p>
                                            <div class="alert alert-warning mb-0">
                                                <i class="bi bi-exclamation-triangle me-1" aria-hidden="true"></i>
                                                <strong>Warning:</strong> This action cannot be undone.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="reset-modal" tabindex="-1" aria-labelledby="reset-modal-title" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reset-modal-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2" aria-hidden="true"></i>
                    Confirm Reset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>This will reset <strong>all credentials</strong> in the selected list to their original default values.</p>
                <div class="alert alert-warning mb-0">
                    <strong>This action cannot be undone.</strong> Any custom passwords will be lost.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-reset-btn">
                    <span class="btn-text">Reset to Defaults</span>
                    <span class="btn-loading d-none">
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        Resetting...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const isAdmin = {{ if .IsAdmin }}true{{ else }}false{{ end }};
    let credlistData = [];
    let resetModal;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        resetModal = new bootstrap.Modal(document.getElementById('reset-modal'));
        initializeSelects();
        initializeForm();
        initializeAdminTabs();
    });

    // ========================================
    // Initialization Functions
    // ========================================

    function initializeSelects() {
        // Load teams
        fetch("/api/teams")
            .then(handleResponse)
            .then(teams => {
                const select = document.getElementById("team-select");
                select.innerHTML = '';
                teams.forEach(team => {
                    const option = document.createElement("option");
                    option.value = team.ID;
                    option.textContent = team.Name;
                    select.appendChild(option);
                });
            })
            .catch(err => {
                console.error("Error loading teams:", err);
                showAlert("Failed to load teams. Please refresh the page.", "danger");
            });

        // Load credential lists
        fetch("/api/credlists")
            .then(handleResponse)
            .then(credlists => {
                credlistData = credlists;
                const select = document.getElementById("credlist-select");
                select.innerHTML = '';
                credlists.forEach(credlist => {
                    const option = document.createElement("option");
                    option.value = credlist.path;
                    option.textContent = credlist.name;
                    select.appendChild(option);
                });
            })
            .catch(err => {
                console.error("Error loading credential lists:", err);
                showAlert("Failed to load credential lists. Please refresh the page.", "danger");
            });

    }

    function initializeForm() {
        const form = document.getElementById("pcr-form");
        const textarea = document.getElementById("pcr-credentials");

        // Live line count
        textarea.addEventListener("input", () => {
            const lines = textarea.value.split("\n").filter(l => l.trim() !== "").length;
            document.getElementById("line-count").textContent =
                `${lines} credential${lines !== 1 ? 's' : ''} entered`;
        });

        // Form submission
        form.addEventListener("submit", handleFormSubmit);

        // Reset button
        document.getElementById("reset-btn").addEventListener("click", () => {
            resetModal.show();
        });

        // Confirm reset
        document.getElementById("confirm-reset-btn").addEventListener("click", handleReset);
    }

    function initializeAdminTabs() {
        // View tab available to everyone
        document.getElementById("view-tab").addEventListener("shown.bs.tab", loadCredentials);
        document.getElementById("refresh-credentials-btn").addEventListener("click", loadCredentials);

        // History tab admin-only
        if (isAdmin) {
            document.getElementById("history-tab").addEventListener("shown.bs.tab", loadHistory);
            document.getElementById("refresh-history-btn").addEventListener("click", loadHistory);
        }

        // Auto-refresh active tab when dropdowns change
        const refreshActiveTab = () => {
            const viewTab = document.getElementById("view-tab");
            if (viewTab.classList.contains("active")) {
                loadCredentials();
            } else if (isAdmin && document.getElementById("history-tab")?.classList.contains("active")) {
                loadHistory();
            }
        };
        document.getElementById("team-select").addEventListener("change", refreshActiveTab);
        document.getElementById("credlist-select").addEventListener("change", refreshActiveTab);
    }

    // ========================================
    // Form Handlers
    // ========================================

    function handleFormSubmit(event) {
        event.preventDefault();

        const textarea = document.getElementById("pcr-credentials");
        const lines = textarea.value.split("\n").filter(l => l.trim() !== "");

        if (lines.length === 0) {
            showAlert("Please enter at least one credential.", "warning");
            textarea.focus();
            return;
        }

        const stripQuotes = document.getElementById("strip-quotes").checked;
        const maybeUnquote = (str) => {
            if (!stripQuotes) return str;
            if ((str.startsWith('"') && str.endsWith('"')) ||
                (str.startsWith("'") && str.endsWith("'"))) {
                return str.slice(1, -1);
            }
            return str;
        };

        const usernames = [];
        const passwords = [];
        for (const line of lines) {
            const parts = line.split(/,(.+)/);
            usernames.push(maybeUnquote(parts[0] ?? ""));
            passwords.push(maybeUnquote(parts[1] ?? ""));
        }

        const data = {
            team_id: document.getElementById("team-select").value,
            credlist_id: document.getElementById("credlist-select").value,
            usernames,
            passwords
        };

        setButtonLoading("submit-btn", true);

        fetch("/api/pcrs/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
        .then(handleResponse)
        .then(result => {
            const hasSkipped = result.skipped && result.skipped.length > 0;

            if (result.count === 0) {
                showAlert("No credentials were updated. Verify usernames exist in the selected list.", "warning");
            } else if (hasSkipped) {
                const skippedText = result.skipped.join(", ");
                showAlert(
                    `${result.count} credential${result.count !== 1 ? 's' : ''} updated. ` +
                    `${result.skipped.length} skipped (not found): ${skippedText}`,
                    "warning"
                );
                textarea.value = "";
            } else {
                showAlert(`${result.count} credential${result.count !== 1 ? 's' : ''} updated successfully!`, "success");
                textarea.value = "";
            }

            // Update line count
            document.getElementById("line-count").textContent = "0 credentials entered";
        })
        .catch(err => {
            console.error("Error submitting PCR:", err);
            showAlert("Failed to submit changes. Please try again.", "danger");
        })
        .finally(() => {
            setButtonLoading("submit-btn", false);
        });
    }

    function handleReset() {
        const data = {
            team_id: document.getElementById("team-select").value,
            credlist_id: document.getElementById("credlist-select").value
        };

        setButtonLoading("confirm-reset-btn", true);

        fetch("/api/pcrs/reset", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
        .then(handleResponse)
        .then(result => {
            resetModal.hide();
            showAlert(result.message || "Credentials reset successfully.", "success");
        })
        .catch(err => {
            console.error("Error resetting PCR:", err);
            showAlert("Failed to reset credentials. Please try again.", "danger");
        })
        .finally(() => {
            setButtonLoading("confirm-reset-btn", false);
        });
    }

    // ========================================
    // Admin Functions
    // ========================================

    function loadCredentials() {
        const credlist = document.getElementById("credlist-select").value;

        // Show loading, hide others
        setAdminPanelState("credentials", "loading");

        if (isAdmin) {
            // Admin: fetch full credentials from API
            const teamId = document.getElementById("team-select").value;
            fetch(`/api/pcrs?team_id=${encodeURIComponent(teamId)}&credlist=${encodeURIComponent(credlist)}`)
                .then(handleResponse)
                .then(data => {
                    if (!data || data.length === 0) {
                        setAdminPanelState("credentials", "empty");
                        return;
                    }
                    renderCredentialsTable(data, true);
                })
                .catch(err => {
                    console.error("Error loading credentials:", err);
                    document.getElementById("credentials-error-msg").textContent =
                        "Failed to load credentials. Please try again.";
                    setAdminPanelState("credentials", "error");
                });
        } else {
            // Non-admin: show usernames from already-loaded credlist data
            const credlistInfo = credlistData.find(c => c.path === credlist);
            if (!credlistInfo || !credlistInfo.usernames || credlistInfo.usernames.length === 0) {
                setAdminPanelState("credentials", "empty");
                return;
            }
            const data = credlistInfo.usernames.map(u => ({ Username: u }));
            renderCredentialsTable(data, false);
        }
    }

    function renderCredentialsTable(data, showPasswords) {
        const tbody = document.getElementById("credentials-table-body");
        tbody.innerHTML = "";

        data.forEach(cred => {
            const row = document.createElement("tr");

            const td1 = document.createElement("td");
            td1.textContent = cred.Username;
            row.appendChild(td1);

            if (showPasswords) {
                const td2 = document.createElement("td");
                const code = document.createElement("code");
                code.textContent = cred.Password;
                td2.appendChild(code);
                row.appendChild(td2);
            }

            tbody.appendChild(row);
        });

        document.getElementById("credentials-count").textContent = data.length;
        setAdminPanelState("credentials", "data");
    }

    function loadHistory() {
        if (!isAdmin) return;

        const teamId = document.getElementById("team-select").value;
        const credlist = document.getElementById("credlist-select").value;

        setAdminPanelState("history", "loading");

        fetch(`/api/pcrs/history?team_id=${encodeURIComponent(teamId)}&credlist=${encodeURIComponent(credlist)}`)
            .then(handleResponse)
            .then(data => {
                if (!data || data.length === 0) {
                    setAdminPanelState("history", "empty");
                    return;
                }

                const tbody = document.getElementById("history-table-body");
                tbody.innerHTML = "";

                data.forEach(entry => {
                    const row = document.createElement("tr");
                    const time = new Date(entry.ChangedAt).toLocaleString();

                    const cells = [
                        { text: entry.Username },
                        { text: entry.OldPassword, code: true },
                        { text: entry.NewPassword, code: true },
                        { text: entry.ChangedBy },
                        { text: time }
                    ];

                    cells.forEach(cell => {
                        const td = document.createElement("td");
                        if (cell.code) {
                            const code = document.createElement("code");
                            code.textContent = cell.text || "(empty)";
                            td.appendChild(code);
                        } else {
                            td.textContent = cell.text;
                        }
                        row.appendChild(td);
                    });

                    tbody.appendChild(row);
                });

                document.getElementById("history-count").textContent = data.length;
                setAdminPanelState("history", "data");
            })
            .catch(err => {
                console.error("Error loading history:", err);
                document.getElementById("history-error-msg").textContent =
                    "Failed to load history. Please try again.";
                setAdminPanelState("history", "error");
            });
    }

    // ========================================
    // Utility Functions
    // ========================================

    function handleResponse(response) {
        if (!response.ok) {
            return Promise.reject(new Error(`HTTP ${response.status}`));
        }
        return response.json();
    }

    function showAlert(message, type = "info") {
        const container = document.getElementById("alert-container");

        const alert = document.createElement("div");
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.setAttribute("role", "alert");

        const icon = {
            success: "check-circle",
            danger: "exclamation-triangle",
            warning: "exclamation-circle",
            info: "info-circle"
        }[type] || "info-circle";

        const iconEl = document.createElement("i");
        iconEl.className = `bi bi-${icon} me-2`;
        iconEl.setAttribute("aria-hidden", "true");
        alert.appendChild(iconEl);

        alert.appendChild(document.createTextNode(message));

        const closeBtn = document.createElement("button");
        closeBtn.type = "button";
        closeBtn.className = "btn-close";
        closeBtn.setAttribute("data-bs-dismiss", "alert");
        closeBtn.setAttribute("aria-label", "Close");
        alert.appendChild(closeBtn);

        container.appendChild(alert);

        // Auto-dismiss after 6 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 6000);
    }

    function setButtonLoading(buttonId, loading) {
        const btn = document.getElementById(buttonId);
        const textEl = btn.querySelector(".btn-text");
        const loadingEl = btn.querySelector(".btn-loading");

        if (loading) {
            btn.disabled = true;
            textEl?.classList.add("d-none");
            loadingEl?.classList.remove("d-none");
        } else {
            btn.disabled = false;
            textEl?.classList.remove("d-none");
            loadingEl?.classList.add("d-none");
        }
    }

    function setAdminPanelState(panel, state) {
        const states = ["loading", "empty", "error", "table-container"];
        states.forEach(s => {
            const el = document.getElementById(`${panel}-${s}`);
            if (el) {
                el.classList.toggle("d-none", s !== state && s !== "table-container");
                if (s === "table-container") {
                    el.classList.toggle("d-none", state !== "data");
                }
            }
        });
    }

</script>
{{ end }}
